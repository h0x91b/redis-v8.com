{% extends 'layout.html' %}

{% block content %}
<div class="row floatleftisright">
	<div class="span3">
		<div class="side_menu right_menu">
			<h3>Docs</h3>
			<nav id="content_menu">
				<ul class="nav">
					<li class="active"><a href="#v8commands">Redis-v8 command list</a></li>
					<li><a href="#jsapi">JS API</a></li>
					<li><a href="#jsapispecial">JS API internals</a></li>
					<li><a href="#redisconf">Redis.conf</a></li>
					<li><a href="#protocol">Protocol</a></li>
					<li><a href="#compiling">Compiling redis-v8</a></li>
					<li><a href="#tutorials">Tutorials</a></li>
					<li><a href="#comments">Comments</a></li>
				</ul>
			</nav>
		</div>
	</div>
	<div class="span9">
		<div class="page-header">
			<h1>Docs <small>Manual & Documentation</small></h1>
		</div>
		<section>
			<div class="post">
				<h2 id="v8commands">Redis-v8 command list</h2>
				<dl>
					<dt>JS</dt>
					<dd>
						JS - command used for execution a js code in database. Return of this function will be JSON encoded. You will need properly escape strings for right js syntax, otherwise  will be return error.
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return 2+2*2';
</pre>
return will be:
						<pre class="prettyprint linenums languague-js">
"{\"ret\":6,\"cmds\":0}"
</pre>
					</dd>
					
					<dt>JSA</dt>
					<dd>
						JSA - command used for execution a js code in database asynchronly. Return of this function will be always {"ret":true, "cmds":0}. You will need properly escape strings for right js syntax, otherwise  will be return error.
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JSA 'makeMillionKeys()';
</pre>
					</dd>
					
					<dt>JSCALL <js_function_name></dt>
					<dd>
						JSCALL - command used for safe and fast execution a js functions in database. Return of this function will be JSON encoded. All arguments will be passed to a js_function_name as a string arguments.
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JSCALL "redis.set" "hello" "world"
$ ./redis-cli JSCALL "redis.get" "hello"
$ ./redis-cli JSCALL "console.log" "hello" "world"
</pre>
					</dd>
					<dt>JSRELOAD</dt>
					<dd>
						JSRELOAD - command used for reinitialize V8 with all user scripts.
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JSRELOAD
</pre>
					</dd>
				</dl>
				
				
				<h2 id="jsapi">JS API</h2>
				<dl>
					<dt>redis.*</dt>
					<dd>
						<p>
							redis Object have all standart redis commands, like redis.get, redis.set, redis.hmset etc...<br>A full list of redis commands you cand find on <a href="http://redis.io/commands" target="_blank">redis.io/commands</a>.
						</p>
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS "redis.set('hello', 'world'); return redis.get('hello');"
$ ./redis-cli JSCALL redis.get 'hello'
</pre>
					</dd>
					<dt>redis.hmset(key,object)</dt>
					<dd>
						redis.hmset
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'redis.hmset("HSET:KEYNAME",{"id":123,"title":"some title","body":"some body"})';
</pre>
					</dd>
					
					<dt>redis.hgetall(key)</dt>
					<dd>
						redis.hgetall - will return a JS Object, or null
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return redis.hgetall("HSET:KEYNAME")';
</pre>
					</dd>
					
					<dt>redis.hmget(key,field1[,field2[,field3...]]) or redis.hmget(key,['field1','field2','field3'])</dt>
					<dd>
						redis.hmget - will return a JS Object, or null
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return redis.hmget("HSET:KEYNAME","id","title","body")';
$ ./redis-cli JS 'return redis.hmget("HSET:KEYNAME",["id","title","body"])';
</pre>
					</dd>
					
					<dt>window</dt>
					<dd>
						window - reference for a global object, like in browsers.
					</dd>
					
					<dt>setTimeout(function, delay_ms)</dt>
					<dd>
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return setTimeout(function(){ console.log("timeout") }, 1000)';
</pre>
					</dd>
					
					<dt>clearTimeout(id)</dt>
					<dd>
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'var id = setTimeout(function(){ console.log("timeout") }, 1000); clearTimeout(id);';
</pre>
					</dd>
					
					<dt>setInterval(function, delay_ms)</dt>
					<dd>
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'setInterval(function(){ console.log("interval") }, 1000)';
</pre>
					</dd>
					
					<dt>clearInterval(id)</dt>
					<dd>
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'var id = setInterval(function(){ console.log("interval") }, 1000); clearInterval(id);';
</pre>
					</dd>
					
					<dt>console.log([arguments])</dt>
					<dd>
						console.log - will print pretified JSON of arguments to redis.log, with loglevel REDIS_NOTICE.
					</dd>
					<dt>console.debug([arguments])</dt>
					<dd>
						console.debug - will print pretified JSON of arguments to redis.log, with loglevel REDIS_DEBUG.
					</dd>
					<dt>console.info([arguments])</dt>
					<dd>
						console.info - will print pretified JSON of arguments to redis.log, with loglevel REDIS_VERBOSE.
					</dd>
					<dt>console.warn([arguments])</dt>
					<dd>
						console.warn - will print pretified JSON of arguments to redis.log, with loglevel REDIS_WARNING.
					</dd>
					<dt>Crypto.md5</dt>
					<dd>
						MD5 hash function
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return Crypto.md5("123")';
#the same, but using JSCALL
$ ./redis-cli JSCALL Crypto.md5 123
</pre>
					</dd>
					<dt>Crypto.sha1</dt>
					<dd>
						SHA1 hash function
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return Crypto.sha1("123")';
#the same, but using JSCALL
$ ./redis-cli JSCALL Crypto.sha1 123
</pre>
					</dd>
					<dt>UnderscoreJS</dt>
					<dd>
						Yep, we have a underscore "_"
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return _.sortBy([1, 2, 3, 4, 5, 6], function(num){ return Math.sin(num); });';
</pre>
					</dd>
					
					<dt>Model(&lt;type&gt; [,object])</dt>
					<dd>
						Creating new entry
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return Model("page", {title: "page title", body: "page body", author: 1})';
</pre>
						Update existing entry (Specify id)
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return Model("page", { id: 1,title: "page title"})';
</pre>
						Queries:
						<pre class="prettyprint linenums languague-js">
# all entries
$ ./redis-cli JS 'return Model("page").getAll()';
# 100 newests
$ ./redis-cli JS 'return Model("page").head(100).getAll()';
# 100 oldest
$ ./redis-cli JS 'return Model("page").tail(100).getAll()';
# where page title contains "page" text
$ ./redis-cli JS 'return Model("page").where("title",function(title){ return title.indexOf("page") != -1; }).getAll()';
# order by
$ ./redis-cli JS 'return Model("page").head(100).getAll().orderBy("raiting", "DESC")';
</pre>
					</dd>
				</dl>
				
				<h2 id="jsapispecial">JS API internals</h2>
				<dl>
					<dt>jscall_wrapper_function</dt>
					<dd>
						jscall_wrapper_function - this is internal function used for JSCALL.
					</dd>
					<dt>redis._run</dt>
					<dd>
						Internal redis-V8 function used in almost all js wrappers. 
						<pre class="prettyprint linenums languague-js">
$ ./redis-cli JS 'return redis._run("SET","Hello","World")';
$ ./redis-cli JS 'return redis._run("HMSET","HSET:KEYNAME","id",123,"title","some tile","body","some body")';
</pre>
					</dd>
					<dt>redis.last_error</dt>
					<dd>
						redis.last_error - will be empty if redis.* command executed succesfully, or will contain error string.
					</dd>
					<dt>redis.v8_start</dt>
					<dd>
						JS timestamp of V8 init, command JSRELOAD will flush it.
					</dd>
					<dt>redis._runcounter</dt>
					<dd>
						Counter of redis api calls.
					</dd>
					<dt>redis.inline_return</dt>
					<dd>
						Internal redis-v8 function, used for JS command wrap and JSON return.
					</dd>
				</dl>
				
				
				<h2 id="redisconf">Redis.conf</h2>
				<dl>
					<dt>js-dir</dt>
					<dd>
						js-dir - path for user scripts folder.
						<pre class="prettyprint linenums languague-js">
js-dir "/var/www/redis-v8/js/"
</pre>
					</dd>
					<dt>js-flags</dt>
					<dd>
						js-flags - Google v8 flags. You can set flags with redis command CONFIG SET js-flags "" and run JSRELOAD.
						<pre class="prettyprint linenums languague-js">
js-flags "--trace_inlining --trace_opt --trace_deopt --trace_opt_verbose --trace_exception --trace-hydrogen"
</pre>
						<p>
							Full list of js-flags you can get by folowing command:
						</p>
						<pre class="prettyprint linenums languague-js">
$ cd redis-v8/
$ ./redis/deps/v8/out/native/d8 --help
</pre>
						
					</dd>
					<dt>js-timeout</dt>
					<dd>
						js-timeout - The time in seconds after which an error will be thrown.
						<pre class="prettyprint linenums languague-js">
js-timeout 30
</pre>
					</dd>
					<dt>js-slow</dt>
					<dd>
						js-slow - The time in miliseconds after which an notice will be logged in redis logfile.
						<pre class="prettyprint linenums languague-js">
js-slow 250
</pre>
					</dd>
				</dl>
				
				
				<h2 id="protocol">Redis-v8 protocol</h2>
				<p>
					Redis-v8 support regular protocol of redis, you can see a specification at <a href="http://redis.io/topics/protocol" target="_blank">redis.io/topics/protocol</a>.
				</p>
				<p>
					JS, and JSCALL commands always return string with JSON, or redis error will be thrown.
				</p>
				<pre class="prettyprint linenums languague-js">
{"ret":6,"cmds":0}

{"ret":"hello","cmds":0}

{"ret":{"object":{"data":[1,2,3,4,5]}},"cmds":0}
</pre>
				<p>
				where "ret" will be function return and "cmds" - counter of DB command was executed on this function call.									
				</p>
				
				
				<h2 id="compiling">Compiling redis-v8</h2>
				<p>
					You will need the following packages:
					<ol>
						<li>clang++</li>
						<li>git</li>
						<li>svn</li>
						<li>vim-common</li>
						<li>jemalloc-devel</li>
						<li>tclsh8.5 - for running unit tests</li>
					</ol>
				</p>
				<p>Getting source and compiling:</p>
				<pre class="prettyprint linenums languague-js">
$ git clone git://github.com/h0x91b/redis-v8.git
$ cd redis-v8/redis
$ make MALLOC=jemalloc
</pre>
				<p>Running redis-v8 server</p>
				<pre class="prettyprint linenums languague-js">
# from the root of redis-v8 folder
$ cd redis/
$ ./redis-server ../redis.conf
</pre>
				<p>Running benchmarks</p>
				<pre class="prettyprint linenums languague-js">
# from the root of redis-v8 folder
$ cd redis/
$ ./redis-benchmark -q -s /tmp/redis.sock
</pre>
				
				<h2 id="tutorials">Tutorials</h2>
				<ol>
					<li><a href="/quick-start/">Quick start</a></li>
				</ol>
				
				<h2 id="comments">Comments</h2>
			    <div id="disqus_thread"></div>
			    <script type="text/javascript">
			        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
			        var disqus_shortname = 'redis-v8'; // required: replace example with your forum shortname

			        /* * * DON'T EDIT BELOW THIS LINE * * */
			        (function() {
			            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			        })();
			    </script>
			    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
			    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
			</div>
		</section>
	</div>
</div>
{% endblock %}